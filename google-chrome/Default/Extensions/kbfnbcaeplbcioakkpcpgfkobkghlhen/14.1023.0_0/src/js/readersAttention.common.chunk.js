(self.webpackChunk=self.webpackChunk||[]).push([[9923],{75003:(e,t,i)=>{i.d(t,{a:()=>s,D:()=>g});var s,n=i(14601),a=i(90361),r=i(78674),o=i(85985),h=i(38983);!function(e){let t,i,s,n;!function(e){e.default="default",e.emogenie="emogenie",e.readersAttention="readersAttention",e.readersAttentionHelp="readersAttentionHelp",e.feedback="feedback",e.settings="settings",e.proofitRequest="proofitRequest",e.proofitReview="proofitReview",e.popup="popup"}(t=e.Type||(e.Type={})),function(e){e.importanceSurvey="importanceSurvey"}(i=e.PopupType||(e.PopupType={})),e.hasAlerts=function(e){switch(e.type){case t.default:case t.emogenie:case t.readersAttention:return!0;default:return!1}},function(e){let t;!function(e){let t;!function(e){e.inlineCard="inlineCard",e.predictionWidget="predictionWidget",e.navigation="navigation",e.readersAttentionItem="readersAttentionItem"}(t=e.Type||(e.Type={}))}(t=e.Caller||(e.Caller={}))}(s=e.ReadersAttention||(e.ReadersAttention={})),function(e){let t;!function(e){e.headerButton="headerButton",e.descriptionLink="descriptionLink"}(t=e.Caller||(e.Caller={}))}(n=e.ReadersAttentionHelp||(e.ReadersAttentionHelp={})),e.isReadersAttention=function(t){return t.type===e.Type.readersAttention},e.isReadersAttentionHelp=function(t){return t.type===e.Type.readersAttentionHelp}}(s||(s={}));class g{constructor(e,t,i,g,c){this.csActions=e,this.gnar=t,this.selectedHighlightsTracker=i,this.isTextFieldEmpty=g,this.browser=c,this.activeView=h.h.create({type:s.Type.default}),this._sub=new n.w,this._viewHistory=[],this.isHeaderNavigationEnabled=this.activeView.view((e=>e.type!==s.Type.feedback)),this._sub.add(this.activeView.subscribe((t=>{switch(t.type){case s.Type.emogenie:return void e.setHideWelcomeEmogenieNotification();case s.Type.settings:return void this.gnar.assistantSettingsShow();case s.Type.proofitRequest:return void this.gnar.proofitRequestFormShow();default:return}}))),this._sub.add(i.subscribe((e=>{if(e.length>0)for(;!s.hasAlerts(this.activeView.get());)this.popActiveView()}))),this._sub.add(g.pipe(r.b(100),o.h(a.fQ)).subscribe((()=>{if(this.activeView.get().type===s.Type.emogenie||this.activeView.get().type===s.Type.readersAttention)for(;this.activeView.get().type!==s.Type.default;)this.popActiveView()})))}pushActiveView(e){const t=this.activeView.get();e.type!==t.type&&(this._viewHistory.push(t),this.activeView.set(e))}popActiveView(){const e=this._viewHistory.pop()||{type:s.Type.default};e.type===s.Type.readersAttention&&(e.caller={type:s.ReadersAttention.Caller.Type.navigation}),this.activeView.set(e)}replaceActiveView(e){e.type!==this.activeView.get().type&&this.activeView.set(e)}get lastView(){return this._viewHistory[this._viewHistory.length-1]||{type:s.Type.default}}dispose(){this._sub.unsubscribe()}}},77869:(e,t,i)=>{i.r(t),i.d(t,{ReadersAttentionFeature:()=>me,getLogName:()=>_e});var s=i(17771),n=i(40327),a=i(8482),r=i(24448),o=i(97757),h=i(14601),g=i(32952),c=i(5114),l=i(38983),d=i(75003),p=i(90361),u=i(2291),_=i(15646),m=i(83078);function f(e){switch(e){case d.a.ReadersAttention.Caller.Type.inlineCard:return"inlineCard";case d.a.ReadersAttention.Caller.Type.predictionWidget:return"predictionWidget";case d.a.ReadersAttention.Caller.Type.navigation:return"navigation";case d.a.ReadersAttention.Caller.Type.readersAttentionItem:return"readersAttentionItem";default:(0,p.vE)(e)}}class v{constructor(e,t,i,s,n){this._gnar=e,this._statistics=t,this._getAttentionScore=i,this._getAlertById=s,this._getSessionUuid=n,this._statsOnOpen=c.none}_getLaunchSourceLabel(e,t){switch(e.type){case d.a.ReadersAttention.Caller.Type.inlineCard:return(0,n.pipe)(this._getAlertById(e.alertId),c.filter((e=>e.isTakeaway)),c.fold((()=>""),(e=>e.title)));case d.a.ReadersAttention.Caller.Type.predictionWidget:return t;case d.a.ReadersAttention.Caller.Type.navigation:return"";case d.a.ReadersAttention.Caller.Type.readersAttentionItem:return e.item.title;default:(0,p.vE)(e)}}_getBasicOpenMetrics(e,t){return{textScore:u.T.prism.reverseGet(this._getAttentionScore()),numWords:this._statistics.wordsCount.get(),alertCounts:this._statistics.alertCounts.get(),launchSource:f(t.type),launchSourceLabel:this._getLaunchSourceLabel(t,e)}}onOpen(e,t,i,s){(0,n.pipe)(this._statsOnOpen,c.fold((()=>c.some({...this._getBasicOpenMetrics(t,s),numCards:i,checklist:e,time:performance.now(),numParagraphs:this._statistics.paragraphsCount.get(),numFormattingSpans:this._statistics.formattingSpansCount.get()})),(()=>c.none)),m.tap((e=>{const t=e.alertCounts.expandedViewSupported,s=e.alertCounts.freeClarity,a=e.alertCounts.critical,r=e.alertCounts.filter((e=>"priority"===e.assistantView)).expandedViewSupported,o=e.checklist.filter((e=>e.checked)).length;this._gnar.attentionPanelShow(Array.from(e.checklist),e.launchSource,e.launchSourceLabel,t,s,a,o,i.takeaway,r,i.nonTakeaway,e.numWords,(0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))),e.textScore),this._statsOnOpen=c.some(e)})))}onClose(e,t){(0,n.pipe)(this._statsOnOpen,m.tap((i=>{const s=performance.now()-i.time,a=i.checklist.filter((e=>e.checked)).length,r=e.filter((e=>e.checked)).length;this._gnar.attentionPanelHide(Array.from(e),Array.from(i.checklist),this._statistics.wordsCount.get(),u.T.prism.reverseGet(this._getAttentionScore()),i.numWords,i.textScore,i.launchSource,i.launchSourceLabel,this._statistics.formattingSpansCount.get(),i.numFormattingSpans,r,a,t.takeaway,i.numCards.takeaway,this._statistics.paragraphsCount.get(),i.numParagraphs,t.nonTakeaway,i.numCards.nonTakeaway,s,(0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>"")))),this._statsOnOpen=c.none})))}onHelpScreenShow(e){this._gnar.attentionHelpScreenShow(e,(0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))))}onTakeawayUserAction(e,t,i,s){switch(i.type){case _.lY.Type.takeawayCorrectlyDetected:return this._gnar.attentionKeyTakeawayFeedbackClick((0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))),s.end,s.start,t,"up");case _.lY.Type.takeawayIncorrectlyDetected:return this._gnar.attentionKeyTakeawayFeedbackClick((0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))),s.end,s.start,t,"down");case _.lY.Type.takeawayDismiss:return this._gnar.attentionKeyTakeawayIgnored(e,(0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))),s.end,s.start,t);case _.lY.Type.takeawayResolve:return this._gnar.attentionKeyTakeawayAcknowledged(e,(0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))),s.end,s.start,t);default:(0,p.vE)(i)}}onKeyTakeawayCardShow(e,t){this._gnar.attentionKeyTakeawayCardShow((0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))),t.end,t.start,e)}onChecklistItemExpand(e){this._gnar.attentionChecklistItemExpand(e.checked,e.id,e.numAlerts,(0,n.pipe)(this._getSessionUuid(),c.getOrElse((()=>""))),e.title)}}var y,w=i(76974),x=i(66310),R=i(77176),b=i(28043),C=i(93508),I=i(85985);!function(e){e.emptyLinesRegex=/([\t ]*\r*\n){2,}/,e.lineBreakRegex=/([\t ]*\r*\n){1,}/,e.split=function({start:t,end:i},s,n=e.emptyLinesRegex){var a;const r=[];if(!n.test(s.slice(t,i)))return[];let o=t;for(;;){const e=s.slice(o,i).match(n),t=null!==(a=null==e?void 0:e.index)&&void 0!==a?a:i-o;if(o!==o+t&&r.push({start:o,end:o+t}),!e)break;o+=t+e[0].length}return r},e.isFormattingChange=function(e){return 0===e.changes.length&&!e.deltaChange.isEmpty}}(y||(y={}));var S,M,k=i(57050);!function(e){e.lerp=function(e,t,i){return(1-i)*e+i*t},e.mean=function(e){return e.reduce(((e,t)=>e+t),0)/e.length}}(S||(S={})),function(e){function t(e){return`rgba(135, 232, 209, ${u.T.prism.reverseGet(e).toFixed(2)})`}e.lerp=function(e,t){return S.lerp(e[0],e[1],t)},e.approxEqual=function(e,t,i=.001){return Math.abs(e[0]-t[0])<i&&Math.abs(e[1]-t[1])<i},e.getAverage=function(e){const t=e.reduce(((e,t)=>e+(t.range.end-t.range.start)),0);return e.reduce(((e,i)=>e+(i.intensity[0]+i.intensity[1])/2*(i.range.end-i.range.start)/t),0)},e.constant=function(e){return[e,e]},e.linear=function(e,t){return[e,t]},e.toColors=function(e){const i=(0,k.flow)(u.T.unsafeFromNumber,t),s=function([e,t]){const i=e=>Math.max(Math.min(e,1),0),[s,n]=[0,1];return{start:S.lerp(s,n,i(e)),end:S.lerp(s,n,i(t))}}(e);return[i(s.start),i(s.end)]},e.heatmapColor=t}(M||(M={}));var T,A=i(36991),F=i(71249);!function(e){let t,i;!function(e){let t;!function(e){e.fromCapi=function(e){return`${e}`},e.toCapi=function(e){return Number(e)},e.create=function(e){return void 0===e?`${p.iy.create().slice(0,6)}`:e}}(t=e.Id||(e.Id={})),e.fromCapi=function(e=[0,0]){return i=>({id:t.fromCapi(i.id),range:{start:i.begin,end:i.end},intensity:i.intensities||e,text:i.text})}}(t=e.Range||(e.Range={})),function(e){let t;!function(e){e[e.v3=3]="v3"}(t=e.Version||(e.Version={}))}(i=e.Capi||(e.Capi={}))}(T||(T={}));class E{constructor(e,t,i,s,n=T.Range.Id.create){this._getClosestRangeToPosition=e,this._getIntersectingRanges=t,this._getLastRevisionSent=i,this._getText=s,this._nextRangeId=n}pushChanges(e,t){var i;const s=(i=e.delta,A.s.normalizeDelta(i).ops.reduce(((e,t)=>{var i;return A.s.isRetain(t)?e.index+=t.retain:A.s.isDelete(t)||A.s.isInsertString(t)&&(e.insertions.push({text:t.insert.trim(),pos:e.index+((null===(i=t.insert.match(/^\s+/))||void 0===i?void 0:i[0].length)||0)}),e.index+=t.insert.length),e}),{index:0,insertions:[]}).insertions.filter((e=>""!==e.text))).filter((e=>!t.resized.find((t=>a.SV.intersects(t.range,{start:e.pos,end:e.pos+e.text.length})))));return F.compact(s.map((e=>this._highlight(e))))}_highlight(e){const t=this._getText(),i=c.toNullable(this._getClosestRangeToPosition(e.pos,(t=>t.range.start<e.pos))),s=!i&&e.pos>0&&""!==t.slice(0,e.pos).trim()||i&&""!==t.slice(i.range.end,e.pos).trim(),n=i&&!t.slice(i.range.end,e.pos).includes("\n");if(s)return c.none;if(i&&n)return c.some(this._highlightInsertionWithRangeOnLeftSide(e,i));const a=c.toNullable(this._getClosestRangeToPosition(e.pos,(t=>t.range.start>=e.pos+e.text.length))),r=a&&!t.slice(e.pos+e.text.length,a.range.start).includes("\n");return a&&r?c.some(this._highlightInsertionWithRangeOnRightSide(e,a)):this._highlightStandaloneInsertion(e)}_highlightInsertionWithRangeOnLeftSide(e,t){const i=L(t,this._getLastRevisionSent());return{id:i?t.id:this._nextRangeId(),range:{start:i?t.range.start:Math.max(t.range.end,e.pos),end:e.pos+e.text.length},intensity:i?t.intensity:M.constant(t.intensity[1])}}_highlightInsertionWithRangeOnRightSide(e,t){const i=L(t,this._getLastRevisionSent());return{id:i?t.id:this._nextRangeId(),range:{start:e.pos,end:i?t.range.end:Math.min(t.range.start,e.pos+e.text.length)},intensity:i?t.intensity:M.constant(t.intensity[0])}}_highlightStandaloneInsertion(e){const t={start:e.pos,end:e.pos+e.text.length};return(0,n.pipe)(this._getIntensityForNewInsertion(t),c.map((i=>({id:this._nextRangeId(),range:t,intensity:i,text:e.text}))))}_getIntensityForNewInsertion(e){const t=y.split({start:0,end:e.start},this._getText(),y.lineBreakRegex),i=y.split({start:e.end,end:this._getText().length},this._getText(),y.lineBreakRegex),s=t.length>0?t[t.length-1]:null,n=i.length>0?i[0]:null;if(s&&n){const e=this._getAverageIntensityOver(s),t=this._getAverageIntensityOver(n);return c.some(M.linear(e,t))}if(s){const e=this._getAverageIntensityOver(s);return c.some(M.constant(e))}if(n){const e=this._getAverageIntensityOver(n);return c.some(M.constant(e))}return c.none}_getAverageIntensityOver(e){const t=this._getIntersectingRanges(e);return M.getAverage(t.map((e=>({range:{start:e.range.start,end:e.range.end},intensity:e.intensity}))))}}function L(e,t){return c.isSome(e.localInfo)&&m.unsafeGet(e.localInfo).lastRevision===t}var O=i(55073),B=i(74850),H=i(25938),$=i(64450);class P{constructor(e){this._text=e,this._log=B.Y.create(_e(P.name)),this._changes=[]}registerRevision(e){this._changes.push({delta:H.RI.delta(new $.Delta,this._text.length),textBeforeChange:this._text,revision:e}),this._log.info(`registered revision ${e}`)}revisionFinished(e){const t=this._changes.findIndex((t=>t.revision===e));if(t<0)return this._log.info(`revision ${e} finished -- not found`),[];const i=this._changes.splice(0,t+1).map((e=>e.revision));return this._log.info(`revision ${e} finished -- dropped [${i.join(", ")}]`),i}getChangesSinceRevision(e){const t=this._changes.findIndex((t=>t.revision===e));if(t<0)return this._log.warn(`revision ${e} not found in history`),c.none;const i=this._changes.slice(t).map((e=>e.delta)),s=i.slice(1).reduce(((e,t)=>e.compose(t)),i[0]);return s.isEmpty?c.none:c.some({textBeforeChanges:this._changes[t].textBeforeChange,delta:s})}pushChanges(e){if(e.isEmpty)return;if(this._text=(0,O.l)(e.delta,this._text),0===this._changes.length)return;const t=this._changes[this._changes.length-1];t.delta=t.delta.compose(e)}get text(){return this._text}}var V,Q=i(76331),N=i(34311),U=i(62337);!function(e){e.stitchAdjacent=function(e,t=1,i=.5,s=.5){const n=function(e,t=.5){const i=e.length>0?[{rects:[e[0]],top:e[0].rect.top,bottom:e[0].rect.top+e[0].rect.height}]:[];for(let s=1;s<e.length;++s){const n=i[i.length-1],a=e[s].rect;n.bottom-a.top>=t*Math.min(n.bottom-n.top,a.height)?(n.rects.push(e[s]),n.top=a.top<n.top?a.top:n.top,n.bottom=a.top+a.height>n.bottom?a.top+a.height:n.bottom):i.push({rects:[e[s]],top:a.top,bottom:a.top+a.height})}return i}(e,s);for(let e=0;e<n.length;++e){if(e>0){const t=n[e].top-n[e-1].bottom,s=n[e].bottom-n[e].top,a=n[e-1].bottom-n[e-1].top;t<Math.min(s,a)*i&&(n[e].top=n[e-1].bottom)}if(e<n.length-1){const t=n[e+1].top-n[e].bottom,s=n[e].bottom-n[e].top,a=n[e+1].bottom-n[e+1].top,r=.5*t;t<Math.min(s,a)*i&&(n[e].bottom=n[e].bottom+r)}for(let t=0;t<n[e].rects.length;++t)n[e].rects[t].rect={...n[e].rects[t].rect,top:n[e].top,height:n[e].bottom-n[e].top};for(let i=1;i<n[e].rects.length;++i){const s=n[e].rects[i-1].rect.left+n[e].rects[i-1].rect.width,a=n[e].rects[i].rect.left-s,r=.5*a;a>0&&a<Math.min(n[e].rects[i].rect.height,n[e].rects[i-1].rect.height)*t&&(n[e].rects[i-1].rect={...n[e].rects[i-1].rect,width:n[e].rects[i-1].rect.width+r},n[e].rects[i].rect={...n[e].rects[i].rect,left:s+r,width:n[e].rects[i].rect.left+n[e].rects[i].rect.width-s-r})}}return n.flatMap((e=>e.rects))},e.getMinDistanceBetween=function(e,t){if(U.UL.intersects(e,t))return 0;const i=e.left+e.width<t.left,s=e.top>t.top+t.height,n=e.left>t.left+t.width,a=e.top+e.height<t.top;return(i||n)&&(a||s)?1/0:i?t.left-(e.left+e.width):n?e.left-(t.left+t.width):a?t.top-(e.top+e.height):e.top-(t.top+t.height)},e.getBoundingBox=function(e){return e.slice(1).reduce(((e,t)=>{const i=Math.min(t.top,e.top),s=Math.min(t.left,e.left);return{top:i,left:s,width:Math.max(e.left+e.width,t.left+t.width)-s,height:Math.max(e.top+e.height,t.top+t.height)-i}}),e[0])}}(V||(V={}));class D{constructor(e,t,i,s,n,a){this._geometryProvider=e,this._geometryLayout=t,this._textFieldRectInvalidated=i,this._formattingChanged=s,this._getTextMap=n,this.heatmapChanges=a,this._highlightsCollection=new Q.C(this._geometryProvider,this._geometryLayout,this._getTextMap,N.qH.everything,this._textFieldRectInvalidated,void 0,void 0,void 0,void 0,B.Y.create(_e(D.name))),this._sub=new h.w,this.geometry=this._highlightsCollection.geometry.view(W),this._sub.add(a.subscribe((e=>this._onRangeChanges(e)))),this._sub.add(this._formattingChanged.subscribe((e=>{this._highlightsCollection.maintainConsistency([],(e=>e),!0)})))}_onRangeChanges(e){this._highlightsCollection.removeHighlights(e.removed.map(N.y$.Id.createFromMark)),"update"===e._tag&&(e.changed.forEach((e=>{this._highlightsCollection.updateHighlight(N.y$.Id.createFromMark(e.id),e.range,{intensity:e.intensity,range:e.range,isLocal:c.isSome(e.localInfo)})})),this._highlightsCollection.maintainConsistency(e.changed.map((e=>N.y$.Id.createFromMark(e.id)))))}dispose(){this._sub.unsubscribe(),this._highlightsCollection.dispose()}}function W(e){const t=function(e){const t=e.map((e=>({...e,boundingBox:V.getBoundingBox(e.rects)}))),i=[...t.slice(0,1).map((e=>({ranges:[e],boundingBox:e.boundingBox})))];for(const e of t.slice(1)){let t=!1;const s=1*S.mean(e.rects.map((e=>e.height)));for(let n=i.length-1;n>=0;--n){const a=i[n];if(V.getMinDistanceBetween(a.boundingBox,e.boundingBox)<=s&&a.ranges.some((t=>V.getMinDistanceBetween(t.boundingBox,e.boundingBox)<=s))){t=!0,a.boundingBox=V.getBoundingBox([a.boundingBox,e.boundingBox]),a.ranges.push(e);break}}t||i.push({ranges:[e],boundingBox:e.boundingBox})}return i.map((e=>e.ranges))}([...e.entries()].filter((e=>!!e[1])).map((([e,{rects:t,meta:{range:i,isLocal:s}}])=>({id:T.Range.Id.create(e),range:i,rects:t,isLocal:s}))).sort(((e,t)=>e.range.start-t.range.start))).map(((e,t)=>e.flatMap((({id:e,rects:i,isLocal:s})=>i.map((i=>({id:e,rect:i,groupIdx:t,isLocal:s}))))).map(((e,t)=>({...e,rectIdx:t}))))).flatMap((e=>V.stitchAdjacent(e))).reduce(((e,{id:t,rect:i,rectIdx:s,groupIdx:n,isLocal:a})=>{var r;return e.has(t)?null===(r=e.get(t))||void 0===r||r.rects.push({...i,rectIdx:s}):e.set(t,{id:t,rects:[{...i,rectIdx:s}],intensities:[],groupIdx:n,isLocal:a}),e}),new Map);for(const[i,s]of t.entries())s.intensities=Y(e.get(N.y$.Id.createFromMark(i)).meta.intensity,s.rects);return t}function Y(e,t){const[i,s]=e,n=(s-i)/t.reduce(((e,t)=>e+t.width),0),a=[];let r=i;for(const e of t){const t=e.width*n;a.push([r,r+t]),r+=t}return t.length>0&&(a[a.length-1][1]=s),a}var j=i(64015),q=i(17889),z=i(51996),G=i(55360);function K({start:e,end:t,meta:{id:i,intensity:s,localInfo:n}}){return{id:i,range:{start:e,end:t},intensity:s,localInfo:n}}class J{constructor(e,t,i,s,n=T.Range.Id.create){this._changesQueue=e,this._rangePositionManager=t,this._localRangeManager=i,this._changesHighlighter=s,this._nextLocalRangeId=n,this._log=B.Y.create(_e(J.name)),this._changes=new g.xQ,this._debug=!1,this.changes=this._changes.asObservable()}get empty(){return this._rangePositionManager.empty}getAllRanges(){return this._rangePositionManager.getAll()}clear(){const e=this._rangePositionManager.clear();this._localRangeManager.clear(),this._log.debug(`clearing heatmap ranges [${e.join(", ")}]`),this._changes.next({_tag:"remove",removed:e})}registerRevision(e){this._changesQueue.registerRevision(e),this._localRangeManager.registerRevision(e)}revisionFinished(e){this._changesQueue.revisionFinished(e);const t=this._localRangeManager.clearRangesRegisteredBeforeRevision(e);t.length>0&&(t.forEach((e=>this._deleteRange(e))),this._changes.next({removed:t,_tag:"remove"}))}onHeatmapMessage(e,t){const i=this._changesQueue.getChangesSinceRevision(t);this._log.debug(`received heatmap for revision ${t} - ${c.fold((()=>"no local changes"),(e=>`local changes ${JSON.stringify(e.delta.delta.ops)}`))(i)}`,e);const s=[],a=[];e.remove.map(T.Range.Id.fromCapi).forEach((e=>{this._deleteRange(e),s.push(e)}));for(const r of e.add.concat(e.update)){if(""===r.text.trim()){this._log.warn(`invalid range #${r.id}, text = [${r.text}] -- dropping`);continue}const e=(0,n.pipe)(i,c.fold((()=>({start:r.begin,end:r.end})),(e=>Z({start:r.begin,end:r.end},e.delta))));this._clearLocalRangesIntersecting(e).forEach((e=>{s.push(e)}));const o=T.Range.Id.fromCapi(r.id),h=r.intensities||(0,n.pipe)(this._rangePositionManager.getById(o),c.chain((e=>e.intensity?c.some(e.intensity):c.none)),c.getOrElse((()=>[0,0]))),g={id:o,range:e,intensity:h};(0,n.pipe)((0,q.nI)(X(this._changesQueue.text,g,this._nextLocalRangeId)),c.fold((()=>{this._setRange(g,t,!1),a.push({...g,localInfo:c.none})}),(e=>{this._deleteRange(o),s.push(o),e.forEach((e=>{this._setRange(e,t,!0),a.push({...e,localInfo:c.some({lastRevision:t})})}))})))}a.length>0?this._changes.next({changed:a,removed:s,_tag:"update"}):s.length>0&&this._changes.next({removed:s,_tag:"remove"})}pushChanges(e){this._debug&&this._log.trace(`processing text changes ${JSON.stringify(e.delta.ops)}`),this._changesQueue.pushChanges(e),(0,n.pipe)(this._rangePositionManager.pushChanges(e),m.tap((t=>this._onTextChanges(e,t))))}_onTextChanges(e,t){const i=new Set,s=new Map;this._changesHighlighter.pushChanges(e,t).flatMap((e=>(0,n.pipe)((0,q.nI)(X(this._changesQueue.text,e,this._nextLocalRangeId)),c.fold((()=>[e]),j.qo)))).forEach((e=>{this._setRange(e,this._localRangeManager.lastRevisionSent,!0),s.set(e.id,{...e,localInfo:c.some({lastRevision:this._localRangeManager.lastRevisionSent})})})),t.collapsed.forEach((e=>{this._deleteRange(e.id),i.add(e.id)})),t.resized.forEach((e=>{(0,n.pipe)((0,q.nI)(X(this._changesQueue.text,e,this._nextLocalRangeId)),c.fold((()=>{s.set(e.id,{...e,localInfo:e.localInfo})}),(t=>{this._deleteRange(e.id),i.add(e.id),t.forEach((e=>{this._setRange(e,this._localRangeManager.lastRevisionSent,!0),s.set(e.id,{...e,localInfo:c.some({lastRevision:this._localRangeManager.lastRevisionSent})})}))})))})),t.shifted.filter((e=>!s.has(e.id))).forEach((e=>s.set(e.id,{...e,localInfo:e.localInfo})));const a={changed:Array.from(s.values()),removed:Array.from(i)};this._debug&&this._log.debug("processed text changes",{...a,ops:JSON.stringify(e.delta.ops)}),a.changed.length>0?this._changes.next({...a,_tag:"update"}):a.removed.length>0&&this._changes.next({removed:a.removed,_tag:"remove"})}_clearLocalRangesIntersecting(e){const t=this._localRangeManager.clearIntersectingRanges(e,(0,k.flow)((e=>this._rangePositionManager.getById(e)),c.map((e=>e.range))));return t.forEach((e=>{this._deleteRange(e),this._log.trace("removed intersecting range",e)})),t}_deleteRange(e){this._rangePositionManager.remove(e)||this._log.debug(`range #${e} already removed`)}_setRange({id:e,range:t,intensity:i},s,n){n&&this._localRangeManager.registerRange(e);const r={start:0,end:this._changesQueue.text.length};a.SV.contains(r,t)||this._log.warn(`range #${e} [${t.start}-${t.end}] is out of bounds: ${a.SV.toString(t)} vs ${a.SV.toString(r)}`),this._rangePositionManager.set(e,t,{intensity:i,localInfo:n?c.some({lastRevision:s}):c.none})}}function X(e,{range:{start:t,end:i},intensity:s},n){return y.split({start:t,end:i},e).map((e=>({id:n(),range:e,intensity:M.linear(S.lerp(s[0],s[1],(e.start-t)/(i-t)),S.lerp(s[0],s[1],(e.end-t)/(i-t)))})))}function Z(e,t){const{changed:i}=(0,G.wb)(t,[z.SV.create(e.start,e.end)]);return(0,n.pipe)(F.head(i),c.fold((()=>e),k.identity),(e=>({start:e.start,end:e.end})))}class ee{constructor(){this._log=B.Y.create(_e(ee.name)),this._revisionsQueue=[],this.clear()}get lastRevisionSent(){return(0,n.pipe)(F.last(this._revisionsQueue),c.chain((e=>e.revision)),c.getOrElse((()=>"no-rev")))}clear(){this._revisionsQueue=[{revision:c.none,ids:new Set}]}registerRange(e){(0,n.pipe)(F.last(this._revisionsQueue),m.tap((t=>{t.ids.add(e)})))}registerRevision(e){this._revisionsQueue.push({revision:c.some(e),ids:new Set})}clearRangesRegisteredBeforeRevision(e){return(0,n.pipe)(this._revisionsQueue,F.findLastIndex((t=>c.isSome(t.revision)&&t.revision.value===e)),c.map((e=>{if(e>0){return this._revisionsQueue.splice(0,e).flatMap((e=>[...e.ids]))}return[]})),m.tap((t=>{const i=[...t];i.length>0&&this._log.trace(`clearing local ranges inserted before ${e} - [${i.join(", ").slice(0,100)}]`)})),c.getOrElse((()=>[])))}clearIntersectingRanges(e,t){const i=[];return this._revisionsQueue.forEach((s=>{s.ids.forEach((r=>(0,n.pipe)(t(r),c.chain(c.fromPredicate((t=>a.SV.intersects(e,{start:t.start,end:t.end})))),m.tap((()=>{i.push(r),s.ids.delete(r)})))))})),i}}class te{constructor(e,t){this._transformRange=t,this._log=B.Y.create(_e(te.name)),this._positionManager=new G.Xr,this._positionManager.pushChanges(H.RI.resFromText(e))}get empty(){return 0===this._positionManager.getRegisteredRanges().length}getAll(){return this._positionManager.getRegisteredRanges().map(this._transformRange)}getById(e){return(0,n.pipe)(c.tryCatch((()=>this._positionManager.getRange(e))),c.map(this._transformRange))}set(e,t,i){c.tryCatch((()=>this._positionManager.deregisterRange(e))),c.tryCatch((()=>this._positionManager.registerRange(e,z.SV.create(t.start,t.end,{...i,_range:t}))))}remove(e){return(0,n.pipe)(c.tryCatch((()=>this._positionManager.deregisterRange(e))),c.fold((()=>!1),(()=>!0)))}clear(){return(0,n.pipe)(this._positionManager.getRegisteredRanges(),F.map((e=>e.meta.id)),F.map((e=>this.remove(e)?c.some(e):c.none)),F.compact)}findClosestToPosition(e,t){return(0,n.pipe)(this._positionManager.findClosestToPosition(e,(0,k.flow)(this._transformRange,t)),c.map(this._transformRange))}findIntersection(e){return this._positionManager.findIntersections(z.SV.create(e.start,e.end)).map(this._transformRange)}pushChanges(e){if(e.isEmpty)return this._log.debug("processed text changes: NO OP"),c.none;const t=this._positionManager.pushChanges(e).changed,i=t.filter((e=>e.meta._range.end-e.meta._range.start!=e.end-e.start&&e.end!==e.start)),s=t.filter((e=>e.meta._range.end===e.end&&e.meta._range.start===e.start&&e.end!==e.start)),n=t.filter((e=>e.meta._range.end-e.meta._range.start==e.end-e.start&&e.meta._range.start!==e.start&&e.end!==e.start)),a=t.filter((e=>e.end===e.start));return t.forEach((e=>{e.meta._range={start:e.start,end:e.end}})),c.some({affected:s.map(this._transformRange),resized:i.map(this._transformRange),shifted:n.map(this._transformRange),collapsed:a.map(this._transformRange)})}}class ie{constructor(e,t,i,s,n,a,r){this._initialText=e,this._textChanges=t,this._geometryInvalidated=i,this._geometryProvider=s,this._geometryLayout=n,this._heatmapVisible=a,this._connectionId=null,this._changesQueue=new P(this._initialText),this._rangePositionManager=new te(this._initialText,K),this._localRangeManager=new ee,this._changesHighlighter=new E(((e,t)=>this._rangePositionManager.findClosestToPosition(e,t)),(e=>this._rangePositionManager.findIntersection(e)),(()=>this._localRangeManager.lastRevisionSent),(()=>this._changesQueue.text)),this._processor=new J(this._changesQueue,this._rangePositionManager,this._localRangeManager,this._changesHighlighter),this._highlights=l.h.create(null),this._version=l.h.create(void 0),this._attentionScore=l.h.create(u.T.unsafeFromNumber(0)),this._sub=new h.w,this.heatmap=this._highlights.pipe((0,x.w)((e=>(null==e?void 0:e.geometry)||(0,w.of)(new Map))),(0,R.U)((e=>({highlights:e,version:this._version.get()})))),this.attentionScore=this._attentionScore.view(),this._sub.add(this._heatmapVisible.pipe((0,b.x)()).subscribe((e=>{var t;null===(t=this._highlights.get())||void 0===t||t.dispose(),e&&this._highlights.set(new D(this._geometryProvider,this._geometryLayout,this._geometryInvalidated,this._textChanges.pipe(I.h((e=>y.isFormattingChange(e.textChanges)||e.textChanges.deltaChange.isEmpty)),R.U((e=>e.textMap))),r,this._processor.changes.pipe((0,C.O)({removed:[],changed:this._processor.getAllRanges(),textMap:r(),_tag:"update"}))))})))}onTextChanges(e){this._processor.pushChanges(e)}onFinished(e){this._processor.revisionFinished(e)}onNewRemoteRevision(e){this._processor.registerRevision(e)}onAttentionHeatmapMessage(e,t){t!==this._connectionId&&null!==this._connectionId&&this._processor.clear(),this._connectionId=t;const i=a.QT.create(t,e.rev);this._processor.onHeatmapMessage(e,i),(0,n.pipe)(e.attentionScore,c.alt((()=>(0,n.pipe)(u.T.fromNumber(M.getAverage(this._processor.getAllRanges())),c.fromEither))),m.tap((e=>this._attentionScore.set(e))))}dispose(){var e;null===(e=this._highlights.get())||void 0===e||e.dispose(),this._sub.unsubscribe()}}var se=i(27378),ne=i(5739),ae=i(2844),re=i(67521);const oe=({heatmap:e,size:t,style:i,className:s,felog:n,debug:a=!1})=>{const r=se.useRef(null);return(0,re.A)((0,ae.aj)(e,t,((e,{width:t,height:i})=>{const s=null==n?void 0:n.attentionHeatmap.renderTime.startMeasure(),o=r.current,h=null==o?void 0:o.getContext("2d");if(o&&h){o.width=t,o.height=i,h.clearRect(0,0,t,i);for(const t of e.highlights.values())t.rects.forEach(((e,i)=>{he(h,t,e,t.intensities[i],a)}));null==s||s.endMeasure()}else null==s||s.cancelMeasure()}))),se.createElement("canvas",{ref:r,style:i,className:s,"data-grammarly-part":"heatmap"})};function he(e,t,i,s,n){const[a,r]=M.toColors(s);if(a!==r){const t=e.createLinearGradient(i.left,0,i.left+i.width,0);t.addColorStop(0,a),t.addColorStop(1,r),e.fillStyle=t}else e.fillStyle=a;if(e.fillRect(i.left,i.top,i.width,i.height),n){e.strokeStyle="black",e.lineWidth=1,e.strokeRect(i.left,i.top,i.width,i.height);const s=`${t.id}-${t.groupIdx}-${i.rectIdx}`,n=12;e.font=`normal normal bold ${n}px Arial`,e.fillStyle="white",e.fillRect(i.left+1,i.top+i.height-1-n,Math.min(i.width,e.measureText(s).width),Math.min(i.height,n)),e.fillStyle="red",e.fillText(s,i.left+1,i.top+i.height-1)}}const ge=({heatmap:e,className:t,style:i,debug:s})=>se.createElement(ne.F.div,{className:t,style:i},e.pipe((0,R.U)((e=>Array.from(e.highlights.values()).flatMap((e=>e.rects.map(((t,i)=>({...t,intensity:e.intensities[i],id:`${e.id}-${i}`,highlightId:e.id,groupIdx:e.groupIdx,isLocal:e.isLocal}))))).map((e=>se.createElement("div",{...s?{"data-highlight-id":e.highlightId,"data-group-idx":e.groupIdx,"data-rect-idx":e.rectIdx}:{},key:e.id,style:{position:"absolute",width:e.width,height:e.height,left:e.left,top:e.top,background:ce(e.intensity),...s?{border:"1px solid "+(e.isLocal?"red":"black")}:{}}})))))));function ce(e){const[t,i]=M.toColors(e);return`linear-gradient(to right, ${t}, ${i})`}var le=i(23866);class de{constructor(e,t,i,s,n){this._useHeatmapCanvas=e,this._service=t,this._visible=i,this._textFieldLayout=s,this._felog=n,this._debug=!1}get view(){return se.createElement(ne.F.Fragment,null,this._visible.view((e=>e?this._useHeatmapCanvas?se.createElement(oe,{debug:this._debug,felog:this._felog,heatmap:this._service.heatmap,size:this._textFieldLayout.scrollSize.behavior,className:le.heatmap}):se.createElement(ge,{debug:this._debug,heatmap:this._service.heatmap,className:le.heatmap}):null)))}}var pe=i(84966);class ue{constructor(){this._takeawaysFeedback=new Map,this._log=B.Y.create("TakeawayFeedbackStore")}registerFeedback(e,t){this._takeawaysFeedback.get(e)!==t&&(this._takeawaysFeedback.set(e,t),this._log.debug(`Feedback "${t}" stored for alert #${e}]`))}deleteFeedback(e){this._takeawaysFeedback.delete(e),this._log.debug(`Removed feedback for alert #${e}`)}get addFeedbackToRawAlertTransformer(){return e=>{if(pe.wQ.isTakeaway(e)){const t=this._takeawaysFeedback.get(e.id);return t?{...e,extra_properties:{...e.extra_properties,takeawayFeedback:t}}:e}return e}}}function _e(e){return`ReadersAttn-${e}`}class me{constructor(e,t,i,s,n,a,d,p,u,_,m,f){this._useHeatmapCanvas=e,this._textObserver=t,this._geometryInvalidated=i,this._geometryProvider=s,this._geometryLayout=n,this._textFieldLayout=a,this._getAlertById=d,this._getSessionUuid=p,this._gnar=u,this._felog=_,this._statistics=m,this._experiments=f,this._subs=new h.w,this.heatmapVisible=l.h.create(!1),this._heatmapReceived=l.h.create(!1),this._messages=l.h.create(c.none),this._rawChecklist=l.h.create({wordsCount:0,items:new Map}),this.rawChecklist=this._rawChecklist.view(),this.tracking=new v(this._gnar,this._statistics,(()=>this._heatmapService.attentionScore.get()),(e=>this._getAlertById(e)),(()=>this._getSessionUuid())),this._textChangesSubject=new g.xQ,this._revisionMeasures=new r.P(50),this._heatmapService=new ie(this._textObserver.getCurrentTextMap().getPlainText(),this._textChangesSubject,this._geometryInvalidated,this._geometryProvider,this._geometryLayout,this.heatmapVisible,(()=>this._textObserver.getCurrentTextMap())),this._heatmapController=new de(this._useHeatmapCanvas,this._heatmapService,this.heatmapVisible,this._textFieldLayout,this._felog),this._feedItemDismissed=!1,this._attentionScoreInfo=l.h.create(c.none),this._feedItemInfo=l.h.create(c.none),this.attentionScoreInfo=this._attentionScoreInfo.view(),this.feedItemInfo=this._feedItemInfo.view(),this.takeawaysFeedbackStore=new ue,this.heatmapView=this._heatmapController.view,this.heatmapReceived=this._heatmapReceived.view(),this.messages=this._messages.view(),this._subs.add(this._textObserver.contentChanges.immediate.subscribe((e=>this._textChangesSubject.next({textChanges:e,textMap:this._textObserver.getCurrentTextMap()})))),this._subs.add(this._textChangesSubject.pipe(o.d.measure(this._felog.attentionHeatmap.textChangeProcessingTime.measure)).subscribe((e=>{this._heatmapService.onTextChanges(e.textChanges.deltaChange)})))}get addFeedbackToRawAlertTransformer(){return this.takeawaysFeedbackStore.addFeedbackToRawAlertTransformer}onDismissFeedItem(){this._feedItemDismissed=!0,this._feedItemInfo.set(c.none)}onNewRemoteRevision(e){const t=this._revisionMeasures.enqueue({revision:e,measure:this._felog.attentionHeatmap.responseTime.startMeasure()});null==t||t.measure.cancelMeasure(),this._heatmapService.onNewRemoteRevision(e)}onAttentionHeatmapMessage(e,t){var i;this._heatmapReceived.set(!0);const r=a.QT.create(t,null!==(i=e.originalRev)&&void 0!==i?i:e.rev),o=this._revisionMeasures.toArray().find((e=>e.revision===r));o&&(this._revisionMeasures.delete(o),o.measure.endMeasure());const h=this._felog.attentionHeatmap.responseProcessingTime.startMeasure();this._heatmapService.onAttentionHeatmapMessage(e,t),h.endMeasure(),(0,n.pipe)(s.Y(c.option)({attentionScore:e.attentionScore,showAttentionCard:e.showAttentionCard}),c.filter((()=>{var e;return!0===(null===(e=this._experiments)||void 0===e?void 0:e.attentionScoreCard)})),c.fold((()=>{this._attentionScoreInfo.set(c.none),this._feedItemInfo.set(c.none)}),(({attentionScore:e,showAttentionCard:t})=>{this._attentionScoreInfo.set(c.some({attentionScore:e,description:"Highlighted text is more likely to be read"})),t?this._feedItemDismissed||this._feedItemInfo.set(c.some({title:"Capture your reader's attention",description:"Highlighted text is more likely to be read",details:c.some("Grammarly predicts where readers may lose focus by comparing the complexity of a sentence to the information it contains. The prediction also considers the length and formatting of the email as a whole."),attentionScore:e})):this._feedItemInfo.set(c.none)})))}onAttentionInfoMessage(e){const t=new Map(this._rawChecklist.get().items);e.checklist.forEach((e=>t.set(e.id,e))),this._rawChecklist.set({wordsCount:e.wordsCount,items:t}),this._messages.set(c.some({headerMessage:e.headerMessage,predictionMessage:e.predictionMessage}))}onFinished(e){this._heatmapService.onFinished(e)}dispose(){this._subs.unsubscribe(),this._heatmapService.dispose()}}},23866:e=>{e.exports={heatmap:"_2rx7l",fadeIn:"_3nM-b"}}}]);